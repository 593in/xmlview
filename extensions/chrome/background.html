<script type="text/javascript" src="dnd_feedback.js"></script>
<script>
	function sendRequest(request, response) {
		chrome.tabs.getSelected(null, function(tab) {
			chrome.tabs.sendRequest(tab.id, request, function(r) {
				if (response)
					response(r);
			});
		});
	}
	
	chrome.omnibox.onInputChanged.addListener(function(text, suggest) {
		sendRequest({action: "xv.search", query: text}, suggest);
	});
	
	chrome.omnibox.onInputStarted.addListener(function() {
		
	});

	chrome.omnibox.onInputCancelled.addListener(function() {
		resetDefaultSuggestion();
	});
	
	chrome.omnibox.onInputEntered.addListener(function(text) {
		sendRequest({action: "xv.search-apply", query: text});
	});
	
	function resetDefaultSuggestion() {
		chrome.omnibox.setDefaultSuggestion({
			description: '<url><match>xv:</match></url> Find node in current XML document'
		});
	}
	
	chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
		if (request.action == 'xv.get-dnd-feedback') {
			sendResponse({image: xv_dnd_feedback.draw(request.text)});
		} else if (request.action == 'xv.copy') {
			var ta = document.getElementById('ta');
			ta.value = request.text;
			ta.select();
			var rv = document.execCommand("copy", false, null);
		}
	});

	resetDefaultSuggestion();
</script>
<textarea id="ta"></textarea>